on:
  release:
    types: [created]
name: Handle Release
jobs:
  build:
    name: Upload Release Asset
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@master
        
      - name: Set GOPATH
      # temporary fix
      # see https://github.com/actions/setup-go/issues/14
        run: |
          echo "##[set-env name=GOPATH;]$(dirname $GITHUB_WORKSPACE)"
          echo "##[add-path]$(dirname $GITHUB_WORKSPACE)/bin"
        shell: bash
    
      - name: Prepare environment
        run: |
          go mod download
          hack/install-gox.sh\

      - name: Install dependencies
        run: |
          go mod tidy && git diff --no-patch --exit-code
          hack/verify-code-patterns.sh
          hack/verify-boilerplate.sh
          hack/run-lint.sh
          go test -short -coverprofile=coverage.txt -covermode=atomic ./...
          hack/make-all.sh
          hack/verify-installation.sh
          hack/ensure-kubectl-installed.sh
          hack/run-integration-tests.sh
          hack/verify-receipts-upgrade-migration.sh

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
      
      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v1-release
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: out/krew.*
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
